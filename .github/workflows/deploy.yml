name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - 'data/signals.json'
      - 'data/history.json'
      - 'index.html'
      - 'style.css'
      - 'script.js'
      - '.nojekyll'
      - 'backend/**'
      - 'utils/**'
      - '.github/workflows/**'
  workflow_dispatch:  # –î–æ–¥–∞—î–º–æ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫—É

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Verify files exist
      run: |
        echo "üìÅ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ —Ñ–∞–π–ª—ñ–≤:"
        ls -la data/
        echo "‚úÖ signals.json: $(wc -l < data/signals.json) —Ä—è–¥–∫—ñ–≤"
        echo "‚úÖ history.json: $(wc -l < data/history.json) –∑–∞–ø–∏—Å—ñ–≤"
        echo "‚úÖ index.html: $(wc -l < index.html) —Ä—è–¥–∫—ñ–≤"
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤–º—ñ—Å—Ç signals.json
        echo "üìã –í–º—ñ—Å—Ç signals.json:"
        cat data/signals.json | jq '.last_update' || echo "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ signals.json"
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Log deployment
      run: |
        echo "üéâ –£—Å–ø—ñ—à–Ω–æ –∑–∞–¥–µ–ø–ª–æ–π–ª–µ–Ω–æ –Ω–∞ GitHub Pages!"
        echo "üåê URL: ${{ steps.deployment.outputs.page_url }}"
        echo "üïê –ß–∞—Å –¥–µ–ø–ª–æ—é: $(date '+%H:%M:%S') UTC"
        echo "üìÖ –ß–∞—Å –ö–∏—ó–≤: $(TZ='Europe/Kiev' date '+%H:%M:%S')"
        
        # –î–æ–¥–∞—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
        LAST_UPDATE=$(cat data/signals.json | jq -r '.last_update // empty')
        if [ -n "$LAST_UPDATE" ]; then
          echo "üîÑ –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∏–≥–Ω–∞–ª—ñ–≤: $LAST_UPDATE"
        else
          echo "‚ö†Ô∏è –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ last_update –≤ signals.json"
        fi
