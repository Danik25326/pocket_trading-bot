name: Generate Trading Signals

on:
  workflow_dispatch:
    inputs:
      language:
        description: '–ú–æ–≤–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Å–∏–≥–Ω–∞–ª—ñ–≤'
        required: true
        default: 'uk'
        type: choice
        options:
          - uk
          - ru
      trigger_source:
        description: '–î–∂–µ—Ä–µ–ª–æ –∑–∞–ø—É—Å–∫—É'
        default: 'manual'
        type: string
  schedule:
    - cron: '*/10 * * * *'  # –ß—ñ—Ç–∫–æ –∫–æ–∂–Ω—ñ 10 —Ö–≤–∏–ª–∏–Ω

permissions:
  contents: write
  pages: write

jobs:
  generate-signals:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Clear all caches
      run: |
        echo "üßπ –û—á–∏—â–µ–Ω–Ω—è –∫–µ—à—É..."
        pip cache purge
        rm -rf ~/.cache/pip
        rm -rf ~/.cache/apt
        sudo apt-get clean
        echo "‚úÖ –ö–µ—à –æ—á–∏—â–µ–Ω–æ"
    
    - name: Upgrade pip and install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        pip install --no-cache-dir -r backend/requirements.txt jq
    
    - name: Create necessary directories
      run: |
        mkdir -p data
        mkdir -p logs
        touch .nojekyll
        
        # –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤—ñ —Ñ–∞–π–ª–∏, —è–∫—â–æ —ó—Ö –Ω–µ–º–∞—î
        if [ ! -f data/signals.json ]; then 
          echo '{"last_update": null, "signals": [], "timezone": "Europe/Kiev (UTC+2)"}' > data/signals.json
        fi
        if [ ! -f data/history.json ]; then 
          echo '[]' > data/history.json
        fi
        if [ ! -f data/assets_config.json ]; then 
          echo '{"preferred_assets": ["GBPJPY_otc", "EURUSD_otc", "USDJPY_otc"]}' > data/assets_config.json
        fi
        if [ ! -f data/lessons.json ]; then 
          echo '[]' > data/lessons.json
        fi
        
        # –î–æ–¥–∞—î–º–æ —Ñ–∞–π–ª –¥–ª—è –¥–µ–ø–ª–æ—é
        echo "" > .nojekyll
        echo "üìÅ –°—Ç–≤–æ—Ä–µ–Ω–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó"
    
    - name: Generate trading signals
      env:
        TZ: 'Europe/Kiev'
        POCKET_SSID: ${{ secrets.POCKET_SSID }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        POCKET_DEMO: 'true'
        SIGNAL_INTERVAL: '600'
        MIN_CONFIDENCE: '0.7'
        MAX_DURATION: '5.0'
        SIGNAL_VALIDITY_MINUTES: '10'
        MAX_SIGNALS_ON_SITE: '6'
        ASSETS: 'GBPJPY_otc,EURUSD_otc,USDJPY_otc'
        TIMEFRAMES: '120'
        LOG_LEVEL: 'INFO'
        GROQ_MODEL: 'openai/gpt-oss-120b'
        LANGUAGE: ${{ inputs.language || 'uk' }}
        TRIGGER_SOURCE: ${{ inputs.trigger_source || 'manual' }}
      run: |
        echo "üöÄ –ü–û–ß–ê–¢–û–ö –ì–ï–ù–ï–†–ê–¶–Ü–á –°–ò–ì–ù–ê–õ–Ü–í"
        echo "=" * 60
        echo "‚è∞ –ó–∞–ø—É—â–µ–Ω–æ: $(TZ='Europe/Kiev' date '+%Y-%m-%d %H:%M:%S') (–ö–∏—ó–≤—Å—å–∫–∏–π —á–∞—Å)"
        echo "üìÖ UTC —á–∞—Å: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "üåê –ú–æ–≤–∞: $LANGUAGE"
        echo "üìä –ê–∫—Ç–∏–≤–∏: $ASSETS"
        echo "üß† –ú–æ–¥–µ–ª—å AI: $GROQ_MODEL"
        echo "üîß –î–∂–µ—Ä–µ–ª–æ –∑–∞–ø—É—Å–∫—É: $TRIGGER_SOURCE"
        echo "‚è±Ô∏è –Ü–Ω—Ç–µ—Ä–≤–∞–ª –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó: 10 —Ö–≤–∏–ª–∏–Ω"
        echo "=" * 60
        
        # –î–æ–¥–∞—Ç–∫–æ–≤–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
        echo "üìã –î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:"
        echo "   - –†–æ–±–æ—á–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è: $(pwd)"
        echo "   - Python —à–ª—è—Ö: $PYTHONPATH"
        echo "   - –¢–∞–π–º–∑–æ–Ω–∞: $TZ"
        
        export PYTHONPATH=$PYTHONPATH:$(pwd)/backend:$(pwd):$(pwd)/utils
        
        cd backend
        python signal_generator.py
        
        echo "‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Å–∏–≥–Ω–∞–ª—ñ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
        echo "üïê –ß–∞—Å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è (–ö–∏—ó–≤): $(TZ='Europe/Kiev' date '+%H:%M:%S')"
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –Ω–æ–≤—ñ —Å–∏–≥–Ω–∞–ª–∏
        if [ -f "../data/signals.json" ]; then
          SIGNAL_COUNT=$(jq '.signals | length' ../data/signals.json)
          LAST_UPDATE=$(jq -r '.last_update' ../data/signals.json)
          echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç: $SIGNAL_COUNT —Å–∏–≥–Ω–∞–ª—ñ–≤"
          echo "üîÑ –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: $LAST_UPDATE"
        else
          echo "‚ö†Ô∏è –§–∞–π–ª signals.json –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
        fi
    
    - name: Commit and push all changes
      run: |
        echo "üíæ –ö–æ–º—ñ—Ç –∑–º—ñ–Ω..."
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
        
        # –î–æ–¥–∞—î–º–æ –≤—Å—ñ –∑–º—ñ–Ω–∏
        git add data/
        git add logs/
        git add .nojekyll
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑–º—ñ–Ω–∏
        echo "üìã –ó–º—ñ–Ω–µ–Ω—ñ —Ñ–∞–π–ª–∏:"
        git status --porcelain
        
        if git diff --staged --quiet; then
          echo "‚ö†Ô∏è –ù–µ–º–∞—î –∑–º—ñ–Ω –¥–ª—è –∫–æ–º—ñ—Ç—É"
        else
          KYIV_TIME=$(TZ='Europe/Kiev' date '+%Y-%m-%d %H:%M')
          git commit -m "ü§ñ –°–∏–≥–Ω–∞–ª–∏: $KYIV_TIME [–ú–æ–≤–∞: ${{ inputs.language || 'uk' }}] [Auto]"
          git push origin main
          echo "‚úÖ –ó–º—ñ–Ω–∏ –∑–∞–∫–æ–º—ñ—á–µ–Ω–æ —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ"
          echo "üì§ –ó–∞–ø—É—â–µ–Ω–æ –ø—É—à –∑ –æ–Ω–æ–≤–ª–µ–Ω–∏–º–∏ —Å–∏–≥–Ω–∞–ª–∞–º–∏"
          
          # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∞—Å –∫–æ–º—ñ—Ç—É
          echo "üïê –ß–∞—Å –∫–æ–º—ñ—Ç—É (UTC): $(date '+%H:%M:%S')"
          echo "üïê –ß–∞—Å –∫–æ–º—ñ—Ç—É (–ö–∏—ó–≤): $(TZ='Europe/Kiev' date '+%H:%M:%S')"
        fi
    
    - name: Trigger deployment
      run: |
        echo "üöÄ –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—é –Ω–∞ GitHub Pages..."
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –æ–Ω–æ–≤–ª–µ–Ω–∏—Ö —Å–∏–≥–Ω–∞–ª—ñ–≤
        if [ -f "data/signals.json" ]; then
          echo "üìÑ –û–Ω–æ–≤–ª–µ–Ω–æ signals.json, –∑–∞–ø—É—Å–∫–∞—î–º–æ –¥–µ–ø–ª–æ–π"
          
          # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ GitHub CLI –¥–ª—è –∑–∞–ø—É—Å–∫—É –¥–µ–ø–ª–æ—é
          gh workflow run deploy.yml --ref main
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–ø—É—â–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ"
          else
            echo "‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –¥–µ–ø–ª–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ"
            echo "‚ÑπÔ∏è –î–µ–ø–ª–æ–π –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —á–µ—Ä–µ–∑ –∫—ñ–ª—å–∫–∞ —Ö–≤–∏–ª–∏–Ω"
          fi
        else
          echo "‚ö†Ô∏è –§–∞–π–ª signals.json –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –¥–µ–ø–ª–æ–π –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ"
        fi
    
    - name: Log completion time
      run: |
        echo "=" * 60
        echo "üèÅ –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
        echo "üïê –ß–∞—Å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è (–ö–∏—ó–≤): $(TZ='Europe/Kiev' date '+%H:%M:%S')"
        echo "üïê –ß–∞—Å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è (UTC): $(date '+%H:%M:%S')"
        
        # –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ —á–∞—Å –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫—É
        CURRENT_MINUTE=$(date +%M)
        NEXT_MINUTE=$(( ( (CURRENT_MINUTE + 10) / 10 ) * 10 ))
        if [ $NEXT_MINUTE -ge 60 ]; then
          NEXT_MINUTE=0
        fi
        
        echo "‚è∞ –ù–∞—Å—Ç—É–ø–Ω–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –∑–∞–ø—É—Å–∫: —á–µ—Ä–µ–∑ $(( (NEXT_MINUTE - CURRENT_MINUTE + 10) % 10 )) —Ö–≤–∏–ª–∏–Ω"
        echo "üìÖ –£ :$NEXT_MINUTE (UTC)"
        echo "=" * 60
